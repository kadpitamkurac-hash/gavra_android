name: ðŸ“¦ Build APK for Download

on:
  workflow_dispatch:
    inputs:
      bump_version:
        description: 'Auto-bump version?'
        required: true
        default: 'false'
        type: boolean

permissions:
  contents: write

env:
  FLUTTER_VERSION: '3.35.6'

jobs:
  build:
    name: ðŸš€ Build APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Bump Version (if requested)
        if: ${{ inputs.bump_version }}
        run: |
          # Read current version
          current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "Current version: $current_version"
          
          # Parse version components (assuming format: major.minor.patch+build)
          version_part=$(echo $current_version | cut -d'+' -f1)
          build_part=$(echo $current_version | cut -d'+' -f2)
          
          # Increment build number
          new_build=$((build_part + 1))
          new_version="$version_part+$new_build"
          
          echo "New version: $new_version"
          
          # Update pubspec.yaml
          sed -i "s/version: $current_version/version: $new_version/" pubspec.yaml
          
          # Commit version bump
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add pubspec.yaml
          git commit -m "Bump version to $new_version"

      - name: Prepare Secrets
        run: |
          mkdir -p android/app
          # Use GitHub secrets if available, otherwise use local keystore for testing
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
            echo "storePassword=${{ secrets.STORE_PASSWORD }}" > android/key.properties
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
            echo "storeFile=upload-keystore.jks" >> android/key.properties
          else
            # Fallback to local keystore for testing (NOT RECOMMENDED FOR PRODUCTION)
            echo "Using local keystore for testing - add GitHub secrets for production!"
            cat keystore_base64.txt | base64 -d > android/app/upload-keystore.jks
            echo "storePassword=GavraRelease2024" > android/key.properties
            echo "keyPassword=GavraRelease2024" >> android/key.properties
            echo "keyAlias=gavra-release-key" >> android/key.properties
            echo "storeFile=upload-keystore.jks" >> android/key.properties
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Build Release APK
        run: flutter build apk --release

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gavra-android-release
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: apk-${{ github.run_number }}
          release_name: ðŸš€ Gavra Android APK Download (Build ${{ github.run_number }})
          body: |
            ðŸ“¦ **Gavra Android APK za download**

            **Verzija:** ${{ github.run_number }}
            **Build vreme:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}

            ### ðŸ“¥ Download
            Preuzmite APK fajl ispod i instalirajte na vaÅ¡ Android ureÄ‘aj.

            âš ï¸ **VaÅ¾no:** Ovo je test verzija. Za produkcijsku verziju koristite Google Play Store.

            ### ðŸ”§ Instalacija
            1. Download-ujte APK fajl
            2. Na vaÅ¡em Android ureÄ‘aju idite u Settings > Security
            3. OmoguÄ‡ite "Unknown Sources"
            4. Instalirajte APK fajl
          draft: false
          prerelease: true

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/app-release.apk
          asset_name: gavra-android-v${{ github.run_number }}.apk
          asset_content_type: application/vnd.android.package-archive
