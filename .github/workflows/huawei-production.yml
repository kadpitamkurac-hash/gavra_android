name: üì± Huawei AppGallery Upload

# Upload na Huawei AppGallery za review
on:
  workflow_dispatch:
    inputs:
      submit_for_review:
        description: 'Submit for review after upload? (default: true)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      release_notes:
        description: 'Release notes (What is new)'
        required: false
        default: 'Ispravke gre≈°aka i pobolj≈°anja performansi.'
      bump_version:
        description: 'Auto-bump version in pubspec.yaml?'
        required: true
        default: 'false'
        type: boolean
      force_replace_review:
        description: 'Force replace/cancel existing review?'
        required: true
        default: 'false'
        type: boolean
  workflow_call:
    inputs:
      git_ref:
        description: 'Git Ref to checkout (optional)'
        required: false
        type: string
      bump_version:
        description: 'Auto-bump version in pubspec.yaml?'
        required: false
        default: false
        type: boolean
      submit_for_review:
         description: 'Submit for review?'
         required: false
         default: 'true'
         type: string
      force_replace_review:
         description: 'Force replace review?'
         required: false
         default: 'false'
         type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.6'

permissions:
  contents: write

jobs:
  build-and-upload-huawei:
    name: üöÄ Build & Upload to Huawei
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Auto-Bump Version
        if: ${{ github.event.inputs.bump_version == 'true' }}
        shell: pwsh
        run: |
          ./bump_version.ps1
          
          # Git configuration
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Commit and push
          git add pubspec.yaml
          if (git diff --staged --quiet) {
            Write-Host "No changes to commit."
          } else {
            git commit -m "Auto-bump version [skip ci]"
            git push origin HEAD:main
            Write-Host "‚úÖ Version bumped and pushed to repo."
          }

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Prepare Secrets (Windows)
        env:
          AGC_BASE64: ${{ secrets.AGC_BASE64 }}
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          # 1. Restore agconnect
          $agcBytes = [System.Convert]::FromBase64String($env:AGC_BASE64)
          New-Item -ItemType Directory -Force -Path "android/app"
          New-Item -ItemType Directory -Force -Path "assets"
          [System.IO.File]::WriteAllBytes("$(Get-Location)\android\app\agconnect-services.json", $agcBytes)
          [System.IO.File]::WriteAllBytes("$(Get-Location)\assets\agconnect-services.json", $agcBytes)

          # 2. Restore Keystore
          $keystoreBytes = [System.Convert]::FromBase64String($env:KEYSTORE_BASE64)
          [System.IO.File]::WriteAllBytes("$(Get-Location)\android\app\upload-keystore.jks", $keystoreBytes)

          # 3. Create key.properties
          $keyProps = "storePassword=$env:STORE_PASSWORD`nkeyPassword=$env:KEY_PASSWORD`nkeyAlias=$env:KEY_ALIAS`nstoreFile=upload-keystore.jks"
          Set-Content -Path "android/key.properties" -Value $keyProps
          Write-Host "[OK] Secrets configured"

      - name: Get dependencies
        run: flutter pub get

      - name: Get version info
        id: version
        run: |
          if ($env:version_name) {
            $verName = $env:version_name
          } else {
             $pubspec = Get-Content pubspec.yaml
             $verLine = $pubspec | Where-Object { $_ -match "^version:" }
             $verName = $verLine -replace "version: (\d+\.\d+\.\d+).*", '$1'
          }
          echo "VERSION=$verName" >> $env:GITHUB_OUTPUT
          Write-Host "[INFO] Version: $verName"

      - name: Build Release APK
        run: |
          flutter build apk --release
          Write-Host "[OK] APK built successfully"

      - name: Upload to Huawei AppGallery (PowerShell)
        id: upload
        env:
          HUAWEI_CLIENT_ID: ${{ secrets.AGC_CLIENT_ID }}
          HUAWEI_CLIENT_SECRET: ${{ secrets.AGC_CLIENT_SECRET }}
          HUAWEI_APP_ID: ${{ secrets.AGC_APP_ID }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          SUBMIT: ${{ inputs.submit_for_review }}
          FORCE_REPLACE: ${{ inputs.force_replace_review }}
        run: |
          $clientId = $env:HUAWEI_CLIENT_ID
          $clientSecret = $env:HUAWEI_CLIENT_SECRET
          $appId = $env:HUAWEI_APP_ID

          Write-Host "[INFO] Uploading to Huawei..."

          # 1. Get Token
          $tokenBody = @{
            client_id = $clientId
            client_secret = $clientSecret
            grant_type = "client_credentials"
          } | ConvertTo-Json
          $tokenResponse = Invoke-RestMethod -Uri "https://connect-api.cloud.huawei.com/api/oauth2/v1/token" -Method Post -Body $tokenBody -ContentType "application/json"
          $accessToken = $tokenResponse.access_token

          if (-not $accessToken) { Write-Error "Failed to get Access Token"; exit 1 }
          Write-Host "‚úÖ Got Access Token"

          # 2. Get Upload URL
          $uploadUrlHeaders = @{ Authorization = "Bearer $accessToken"; client_id = $clientId }
          
          # 2.1 Cancel Previous Review (If requested)
          if ($env:FORCE_REPLACE -eq 'true') {
             Write-Host "‚ö†Ô∏è Force Replace: Attempting to cancel previous submission..."
             try {
                $cancelUrl = "https://connect-api.cloud.huawei.com/api/publish/v2/app-cancel-submit?appId=$appId"
                Invoke-RestMethod -Uri $cancelUrl -Method Put -Headers $uploadUrlHeaders -ContentType "application/json"
                Write-Host "‚úÖ Previous submission cancelled."
                Start-Sleep -Seconds 5
             } catch {
                Write-Host "‚ÑπÔ∏è Cancel attempt ignored (App probably not in review). Details: $($_.Exception.Message)"
             }
          }

          $uploadUrlResponse = Invoke-RestMethod -Uri "https://connect-api.cloud.huawei.com/api/publish/v2/upload-url?appId=$appId&suffix=apk" -Headers $uploadUrlHeaders -Method Get
          $uploadUrl = $uploadUrlResponse.uploadUrl
          $authCode = $uploadUrlResponse.authCode
          
          if (-not $uploadUrl) { Write-Error "Failed to get Upload URL"; exit 1 }

          # 3. Upload APK (Using curl.exe because Invoke-RestMethod multipart is tricky without .NET classes)
          $apkPath = "build\app\outputs\flutter-apk\app-release.apk"
          
          Write-Host "üöÄ Uploading file via curl.exe..."
          $curlArgs = @("-k", "-s", "-X", "POST", "$uploadUrl", "-F", "file=@$apkPath", "-F", "authCode=$authCode", "-F", "fileCount=1")
          $uploadResult = & curl.exe @curlArgs
          
          # Parse result (it is JSON string)
          $uploadJson = $uploadResult | ConvertFrom-Json
          $fileDestUrl = $uploadJson.result.UploadFileRsp.fileInfoList[0].fileDestUlr

          if (-not $fileDestUrl) { Write-Error "Failed to upload APK: $uploadResult"; exit 1 }
          Write-Host "‚úÖ Uploaded. Dest URL: $fileDestUrl"

          # 4. Update App File Info
          $updateBody = @{
            appId = $appId
            fileType = 5 # 5=APK
            files = @( @{ fileName = "app-release.apk"; fileDestUrl = $fileDestUrl } )
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri "https://connect-api.cloud.huawei.com/api/publish/v2/app-file-info?appId=$appId" -Method Put -Headers $uploadUrlHeaders -Body $updateBody -ContentType "application/json"
          Write-Host "‚úÖ App File Info Updated"

          # 5. Submit for Review
          if ($env:SUBMIT -eq 'true') {
             Write-Host "üì§ Submitting for Review..."
             $submitBody = @{ appId = $appId } | ConvertTo-Json
             try {
                Invoke-RestMethod -Uri "https://connect-api.cloud.huawei.com/api/publish/v2/app-submit?appId=$appId" -Method Post -Headers $uploadUrlHeaders -Body $submitBody -ContentType "application/json"
                Write-Host "‚úÖ App submitted successfully!"
             } catch {
                Write-Host "‚ö†Ô∏è Submit failed. It might be already in review."
                Write-Host "Error details: $($_.Exception.Message)"
                Write-Host "Please check AppGallery Connect manually."
             }
          }

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: huawei-apk-v${{ steps.version.outputs.VERSION }}
          path: build\app\outputs\flutter-apk\app-release.apk
          retention-days: 30
