name: üì± Huawei AppGallery Upload

# Upload na Huawei AppGallery za review
on:
  workflow_dispatch:
    inputs:
      submit_for_review:
        description: 'Submit for review after upload? (default: true)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      release_notes:
        description: 'Release notes (What is new)'
        required: false
        default: 'Ispravke gre≈°aka i pobolj≈°anja performansi.'
      bump_version:
        description: 'Auto-bump version in pubspec.yaml?'
        required: true
        default: 'false'
        type: boolean
      force_replace_review:
        description: 'Force replace/cancel existing review?'
        required: true
        default: 'false'
        type: boolean
  workflow_call:
    inputs:
      git_ref:
        description: 'Git Ref to checkout (optional)'
        required: false
        type: string
      bump_version:
        description: 'Auto-bump version in pubspec.yaml?'
        required: false
        default: false
        type: boolean
      submit_for_review:
         description: 'Submit for review?'
         required: false
         default: 'true'
         type: string
      force_replace_review:
         description: 'Force replace review?'
         required: false
         default: 'false'
         type: string
      release_notes:
         description: 'Release notes'
         required: false
         default: 'Ispravke gre≈°aka i pobolj≈°anja performansi.'
         type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.6'

permissions:
  contents: write

jobs:
  build-and-upload-huawei:
    name: üöÄ Build & Upload to Huawei
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Auto-Bump Version
        if: ${{ github.event.inputs.bump_version == 'true' }}
        shell: bash
        run: |
          # Read version from pubspec.yaml
          LINE=$(grep "^version: " pubspec.yaml)
          VERSION_PART=$(echo "$LINE" | sed 's/version: //g' | cut -d+ -f1)
          BUILD_PART=$(echo "$LINE" | sed 's/.*+//g')

          # Split version into major.minor.patch
          IFS='.' read -r -a parts <<< "$VERSION_PART"
          MAJOR="${parts[0]}"
          MINOR="${parts[1]}"
          PATCH="${parts[2]}"

          # Increment Patch and Build (Patch + 1, Build + 1)
          NEW_PATCH=$((PATCH + 1))
          NEW_BUILD=$((BUILD_PART + 1))

          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH+$NEW_BUILD"
          echo "[INFO] Bumping version: $VERSION_PART+$BUILD_PART -> $NEW_VERSION"

          # Update file using sed (inplace)
          sed -i "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml

          # Git commit and push
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add pubspec.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-bump version [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "‚úÖ Version bumped and pushed."
          fi

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Prepare Secrets (Linux)
        env:
          AGC_BASE64: ${{ secrets.AGC_BASE64 }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          # 1. Restore agconnect
          mkdir -p android/app
          mkdir -p assets
          echo "${{ secrets.AGC_BASE64 }}" | base64 -d > android/app/agconnect-services.json
          cp android/app/agconnect-services.json assets/agconnect-services.json

          # 2. Restore Keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

          # 3. Create key.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          
          echo "[OK] Secrets configured"

      - name: üõ°Ô∏è Verify Keystore (Fail Fast)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        shell: bash
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "KEYSTORE_BASE64 is empty/null!"
            exit 1
          fi
          
          if [ -f "android/app/upload-keystore.jks" ]; then
            SIZE=$(stat -c%s "android/app/upload-keystore.jks")
            echo "Keystore size: $SIZE bytes"
          else
            echo "Keystore file validation failed: File not found!"
            exit 1
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Get version info
        id: version
        shell: bash
        run: |
          if [ -n "$version_name" ]; then
            VER_NAME="$version_name"
          else
             VER_NAME=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d+ -f1)
          fi
          echo "VERSION=$VER_NAME" >> $GITHUB_OUTPUT
          echo "[INFO] Version: $VER_NAME"

      - name: Build Release APK
        run: |
          flutter build apk --release
          echo "[OK] APK built successfully"

      - name: Upload to Huawei AppGallery (Bash)
        id: upload
        env:
          HUAWEI_CLIENT_ID: ${{ secrets.AGC_CLIENT_ID }}
          HUAWEI_CLIENT_SECRET: ${{ secrets.AGC_CLIENT_SECRET }}
          HUAWEI_APP_ID: ${{ secrets.AGC_APP_ID }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          SUBMIT: ${{ inputs.submit_for_review }}
          FORCE_REPLACE: ${{ inputs.force_replace_review }}
        shell: bash
        run: |
          echo "[INFO] Uploading to Huawei..."

          # 1. Get Token
          TOKEN_RESPONSE=$(curl -s -X POST "https://connect-api.cloud.huawei.com/api/oauth2/v1/token" \
            -H "Content-Type: application/json" \
            -d "{\"client_id\": \"$HUAWEI_CLIENT_ID\", \"client_secret\": \"$HUAWEI_CLIENT_SECRET\", \"grant_type\": \"client_credentials\"}")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')

          if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to get Access Token: $TOKEN_RESPONSE"
            exit 1
          fi
          echo "‚úÖ Got Access Token"

          # 2. Get Upload URL
          # 2.1 Cancel Previous Review (If requested)
          if [ "$FORCE_REPLACE" == "true" ]; then
             echo "‚ö†Ô∏è Force Replace: Attempting to cancel previous submission..."
             CANCEL_URL="https://connect-api.cloud.huawei.com/api/publish/v2/app-cancel-submit?appId=$HUAWEI_APP_ID"
             curl -s -X PUT "$CANCEL_URL" \
               -H "Authorization: Bearer $ACCESS_TOKEN" \
               -H "client_id: $HUAWEI_CLIENT_ID" \
               -H "Content-Type: application/json" || echo "‚ÑπÔ∏è Cancel attempt ignored."
             sleep 5
          fi

          UPLOAD_URL_RESPONSE=$(curl -s -X GET "https://connect-api.cloud.huawei.com/api/publish/v2/upload-url?appId=${HUAWEI_APP_ID}&suffix=apk" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "client_id: $HUAWEI_CLIENT_ID")
          
          echo "Debug: UPLOAD_URL_RESPONSE=$UPLOAD_URL_RESPONSE"
          
          UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.uploadUrl')
          AUTH_CODE=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.authCode')
          
          if [ "$UPLOAD_URL" == "null" ] || [ -z "$UPLOAD_URL" ]; then
             echo "Failed to get Upload URL: $UPLOAD_URL_RESPONSE"
             exit 1
          fi

          # 3. Upload APK
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          echo "üöÄ Uploading file..."
          # Note: Huawei requires 'file' and 'authCode' and 'fileCount'
          UPLOAD_RESULT=$(curl -s -k -X POST "$UPLOAD_URL" \
            -F "file=@$APK_PATH" \
            -F "authCode=$AUTH_CODE" \
            -F "fileCount=1")
          
          FILE_DEST_URL=$(echo "$UPLOAD_RESULT" | jq -r '.result.UploadFileRsp.fileInfoList[0].fileDestUlr')

          if [ "$FILE_DEST_URL" == "null" ] || [ -z "$FILE_DEST_URL" ]; then
             echo "Failed to upload APK: $UPLOAD_RESULT"
             exit 1
          fi
          echo "‚úÖ Uploaded. Dest URL: $FILE_DEST_URL"

          # 4. Update App File Info
          # Construct JSON body safely
          UPDATE_BODY=$(jq -n \
            --arg appId "$HUAWEI_APP_ID" \
            --arg fileDestUrl "$FILE_DEST_URL" \
            '{appId: $appId, fileType: 5, files: [{fileName: "app-release.apk", fileDestUrl: $fileDestUrl}]}')

          curl -s -X PUT "https://connect-api.cloud.huawei.com/api/publish/v2/app-file-info?appId=$HUAWEI_APP_ID" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "client_id: $HUAWEI_CLIENT_ID" \
            -H "Content-Type: application/json" \
            -d "$UPDATE_BODY"
            
          echo "‚úÖ App File Info Updated"

          # 5. Submit for Review
          if [ "$SUBMIT" == "true" ]; then
             echo "üì§ Submitting for Review..."
             SUBMIT_BODY=$(jq -n --arg appId "$HUAWEI_APP_ID" '{appId: $appId}')
             
             RESPONSE=$(curl -s -X POST "https://connect-api.cloud.huawei.com/api/publish/v2/app-submit?appId=$HUAWEI_APP_ID" \
               -H "Authorization: Bearer $ACCESS_TOKEN" \
               -H "client_id: $HUAWEI_CLIENT_ID" \
               -H "Content-Type: application/json" \
               -d "$SUBMIT_BODY")
               
             echo "Submit Response: $RESPONSE"
          fi

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: huawei-apk-v${{ steps.version.outputs.VERSION }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
