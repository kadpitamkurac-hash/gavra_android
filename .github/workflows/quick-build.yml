name: ðŸ“² Quick Build (Driver Download)

on:
  workflow_dispatch:
    inputs:
      changelog:
        description: 'What changed in this build?'
        required: false
        default: 'Bug fixes and improvements'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/gavra-release-key-production.keystore
        shell: bash
      
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.STORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../gavra-release-key-production.keystore
          EOF
        shell: bash
      
      - name: Flutter Clean
        run: flutter clean
      
      - name: Build APK
        run: flutter build apk --release -v 2>&1 | tee build.log
      
      - name: Check Build Output
        if: always()
        run: |
          echo "=== Build Log (Last 150 lines) ==="
          if [ -f build.log ]; then
            tail -n 150 build.log
          fi
          echo ""
          echo "=== Searching for APK files ==="
          find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          echo ""
          echo "=== Full build directory ==="
          find build/app/outputs -type f 2>/dev/null || echo "build/app/outputs not found"
      
      - name: Get Version
        run: |
          VERSION=$(grep "version:" pubspec.yaml | head -1 | cut -d: -f2 | xargs)
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Rename and Prepare APK
        if: always()
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ“ APK file found, preparing for upload..."
            VERSION=${{ env.APP_VERSION }}
            BUILD_NUM=${{ github.run_number }}
            mkdir -p release_apk
            cp "build/app/outputs/flutter-apk/app-release.apk" "release_apk/gavra-v${VERSION}-build${BUILD_NUM}.apk"
            echo "APK_NAME=gavra-v${VERSION}-build${BUILD_NUM}.apk" >> $GITHUB_ENV
            echo "APK_PATH=release_apk/gavra-v${VERSION}-build${BUILD_NUM}.apk" >> $GITHUB_ENV
          else
            echo "âœ— APK file not found!"
            echo "Looking for any apk files..."
            find . -name "*.apk" -type f 2>/dev/null
            exit 1
          fi
      
      - name: Generate download link
        id: link
        run: |
          RUN_ID=${{ github.run_id }}
          DOWNLOAD_URL="https://github.com/kadpitamkurac-hash/gavra_android/actions/runs/${RUN_ID}"
          echo "download_url=${DOWNLOAD_URL}" >> $GITHUB_OUTPUT
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
      
      - name: Generate QR Code
        if: success()
        run: |
          pip install qrcode[pil]
          python3 << 'EOF'
          import qrcode
          qr = qrcode.QRCode(
              version=1,
              error_correction=qrcode.constants.ERROR_CORRECT_L,
              box_size=10,
              border=4,
          )
          qr.add_data("${{ steps.link.outputs.download_url }}")
          qr.make(fit=True)
          img = qr.make_image(fill_color="black", back_color="white")
          img.save("qrcode.png")
          EOF
      
      - name: Upload APK as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}
          path: |
            ${{ env.APK_PATH }}
            qrcode.png
          retention-days: 30
          compression-level: 0
      
      - name: Display Download Instructions
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         âœ… APK BUILD COMPLETED SUCCESSFULLY!           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¥ DOWNLOAD APK - 2 OPTIONS:"
          echo ""
          echo "   OPTION 1 - SCAN QR CODE (Most Convenient!):"
          echo "   ðŸ“± A QR code image was generated!"
          echo "   ðŸ“· Scan it with your phone camera â†’ Opens download link"
          echo ""
          echo "   OPTION 2 - DIRECT LINK:"
          echo "   ðŸ”— ${{ steps.link.outputs.download_url }}"
          echo ""
          echo "ðŸ“‹ BUILD CHANGELOG:"
          echo "   ${{ github.event.inputs.changelog }}"
          echo ""
          echo "â¬‡ï¸  HOW TO INSTALL:"
          echo "   1. Download the APK from link or QR code"
          echo "   2. Transfer to your Android phone"
          echo "   3. Open file manager and tap the APK"
          echo "   4. Accept installation"
          echo "   5. Done! âœ¨"
          echo ""
          echo "ðŸ“¦ FILE: ${{ env.APK_NAME }}"
          echo "ðŸ“Š VERSION: ${{ env.VERSION }}"
          echo ""
