name: ðŸ“² Quick Build (Driver Download)

on:
  workflow_dispatch:
    inputs:
      changelog:
        description: 'What changed in this build?'
        required: false
        default: 'Bug fixes and improvements'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/gavra-release-key-production.keystore
        shell: bash
      
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.STORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../gavra-release-key-production.keystore
          EOF
        shell: bash
      
      - name: Flutter Clean
        run: flutter clean
      
      - name: Build APK
        run: flutter build apk --release -v 2>&1 | tee build.log
      
      - name: Check Build Output
        if: always()
        run: |
          echo "=== Build Log (Last 150 lines) ==="
          if [ -f build.log ]; then
            tail -n 150 build.log
          fi
          echo ""
          echo "=== Searching for APK files ==="
          find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          echo ""
          echo "=== Full build directory ==="
          find build/app/outputs -type f 2>/dev/null || echo "build/app/outputs not found"
      
      - name: Upload build log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.run_id }}
          path: build.log
      
      - name: Get Version
        run: |
          VERSION=$(grep "version:" pubspec.yaml | head -1 | cut -d: -f2 | xargs)
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Rename and Prepare APK
        if: always()
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ“ APK file found, preparing for upload..."
            VERSION=${{ env.APP_VERSION }}
            BUILD_NUM=${{ github.run_number }}
            mkdir -p release_apk
            cp "build/app/outputs/flutter-apk/app-release.apk" "release_apk/gavra-v${VERSION}-build${BUILD_NUM}.apk"
            echo "APK_NAME=gavra-v${VERSION}-build${BUILD_NUM}.apk" >> $GITHUB_ENV
            echo "APK_PATH=release_apk/gavra-v${VERSION}-build${BUILD_NUM}.apk" >> $GITHUB_ENV
          else
            echo "âœ— APK file not found!"
            echo "Looking for any apk files..."
            find . -name "*.apk" -type f 2>/dev/null
            exit 1
          fi
      
      - name: Upload APK to File.io
        if: success()
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          APK_PATH="${{ env.APK_PATH }}"
          if [ -f "$APK_PATH" ]; then
            echo "Uploading APK to File.io..."
            RESPONSE=$(curl -F "file=@$APK_PATH" https://file.io)
            DOWNLOAD_LINK=$(echo $RESPONSE | jq -r '.link')
            if [ "$DOWNLOAD_LINK" != "null" ] && [ -n "$DOWNLOAD_LINK" ]; then
              echo "FILE_IO_LINK=$DOWNLOAD_LINK" >> $GITHUB_ENV
              echo "âœ“ Upload successful! Link: $DOWNLOAD_LINK"
            else
              echo "âœ— Upload failed! Response: $RESPONSE"
              exit 1
            fi
          else
            echo "âœ— APK file not found for upload!"
            exit 1
          fi
      
      - name: Generate QR Code for File.io Link
        if: success()
        run: |
          pip install qrcode[pil]
          python3 << 'EOF'
          import qrcode
          qr = qrcode.QRCode(
              version=1,
              error_correction=qrcode.constants.ERROR_CORRECT_L,
              box_size=10,
              border=4,
          )
          qr.add_data("${{ env.FILE_IO_LINK }}")
          qr.make(fit=True)
          img = qr.make_image(fill_color="black", back_color="white")
          img.save("qrcode.png")
          EOF
      
      - name: Upload QR Code as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: qr-code-${{ github.run_number }}
          path: qrcode.png
          retention-days: 30
      
      - name: Display Download Instructions
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         âœ… APK BUILD COMPLETED SUCCESSFULLY!           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¥ DOWNLOAD APK - SCAN QR CODE:"
          echo ""
          echo "   ðŸ“± A QR code image was generated!"
          echo "   ðŸ“· Scan it with your phone camera â†’ Direct APK download"
          echo "   â° Link expires in 14 days"
          echo ""
          echo "   ðŸ”— Direct Link: ${{ env.FILE_IO_LINK }}"
          echo ""
          echo "ðŸ“‹ BUILD CHANGELOG:"
          echo "   ${{ github.event.inputs.changelog }}"
          echo ""
          echo "â¬‡ï¸  HOW TO INSTALL:"
          echo "   1. Scan QR code or open direct link"
          echo "   2. Download the APK"
          echo "   3. Transfer to your Android phone (if needed)"
          echo "   4. Open file manager and tap the APK"
          echo "   5. Accept installation"
          echo "   6. Done! âœ¨"
          echo ""
          echo "ðŸ“¦ FILE: ${{ env.APK_NAME }}"
          echo "ðŸ“Š VERSION: ${{ env.VERSION }}"
          echo ""
