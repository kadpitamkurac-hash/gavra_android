name: ğŸ“² Quick Build (Driver Download)

on:
  workflow_dispatch:
    inputs:
      changelog:
        description: 'What changed in this build?'
        required: false
        default: 'Bug fixes and improvements'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/gavra-release-key-production.keystore
        shell: bash
      
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_STORE_PASSWORD }}
          keyPassword=${{ secrets.KEYSTORE_KEY_PASSWORD }}
          keyAlias=${{ secrets.KEYSTORE_KEY_ALIAS }}
          storeFile=../gavra-release-key-production.keystore
          EOF
        shell: bash
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Rename APK
        run: |
          VERSION=$(grep "version:" pubspec.yaml | head -1 | cut -d: -f2 | xargs)
          BUILD_NUM=${{ github.run_number }}
          mv build/app/outputs/apk/release/app-release.apk build/app/outputs/apk/release/gavra-v${VERSION}-build${BUILD_NUM}.apk
          echo "APK_NAME=gavra-v${VERSION}-build${BUILD_NUM}.apk" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
      
      - name: Generate download link
        id: link
        run: |
          RUN_ID=${{ github.run_id }}
          DOWNLOAD_URL="https://github.com/kadpitamkurac-hash/gavra_android/actions/runs/${RUN_ID}"
          echo "download_url=${DOWNLOAD_URL}" >> $GITHUB_OUTPUT
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
      
      - name: Generate QR Code
        uses: snow-actions/qrcode@v1.0
        with:
          text: ${{ steps.link.outputs.download_url }}
          path: qrcode.png
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}
          path: |
            build/app/outputs/apk/release/${{ env.APK_NAME }}
            qrcode.png
          retention-days: 30
          compression-level: 0
      
      - name: Display Download Instructions
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         âœ… APK BUILD COMPLETED SUCCESSFULLY!           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¥ DOWNLOAD APK - 2 OPTIONS:"
          echo ""
          echo "   OPTION 1 - SCAN QR CODE (Most Convenient!):"
          echo "   ğŸ“± A QR code image was generated!"
          echo "   ğŸ“· Scan it with your phone camera â†’ Opens download link"
          echo ""
          echo "   OPTION 2 - DIRECT LINK:"
          echo "   ğŸ”— ${{ steps.link.outputs.download_url }}"
          echo ""
          echo "ğŸ“‹ BUILD CHANGELOG:"
          echo "   ${{ github.event.inputs.changelog }}"
          echo ""
          echo "â¬‡ï¸  HOW TO INSTALL:"
          echo "   1. Download the APK from link or QR code"
          echo "   2. Transfer to your Android phone"
          echo "   3. Open file manager and tap the APK"
          echo "   4. Accept installation"
          echo "   5. Done! âœ¨"
          echo ""
          echo "ğŸ“¦ FILE: ${{ env.APK_NAME }}"
          echo "ğŸ“Š VERSION: ${{ env.VERSION }}"
          echo ""
