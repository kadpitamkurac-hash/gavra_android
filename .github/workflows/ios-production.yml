name: üçé iOS Production Release

on:
  workflow_dispatch:
    inputs:
      submit_for_review:
        description: 'Submit for App Store review after upload?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: ''
      force_replace_review:
        description: 'Automatically replace an existing in-review submission (use with caution)'
        required: true
        default: 'false'
      bump_version:
        description: 'Auto-bump version in pubspec.yaml?'
        required: true
        default: 'true'
        type: boolean
  workflow_call:
    inputs:
      git_ref:
        description: 'Git Ref to checkout (optional)'
        required: false
        type: string
      bump_version:
        description: 'Auto-bump version in pubspec.yaml?'
        required: false
        default: false
        type: boolean
      force_replace_review:
         description: 'Force replace review?'
         required: false
         default: 'false'
         type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.6'
  BUNDLE_ID: 'com.gavra013.gavra013ios'
  APP_ID: '6757114361'
  VERSION_ID: 'a4397448-6ed5-4220-82df-1b84e1a63657'

permissions:
  contents: write

jobs:
  build-and-submit:
    name: üöÄ Build & Submit to App Store
    runs-on: macos-latest
    env:
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Auto-Bump Version
        if: ${{ github.event.inputs.bump_version == 'true' }}
        shell: pwsh
        run: |
          ./bump_version.ps1
          
          # Git configuration
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Commit and push
          git add pubspec.yaml
          if (git diff --staged --quiet) {
            Write-Host "No changes to commit."
          } else {
            git commit -m "Auto-bump version to $(grep 'version:' pubspec.yaml) [skip ci]"
            git push
            Write-Host "‚úÖ Version bumped and pushed to repo."
          }

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Codemagic CLI Tools
        run: pip install codemagic-cli-tools

      - name: Get dependencies
        run: flutter pub get

      - name: Setup keychain
        run: keychain initialize

      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create

      - name: Setup certificates
        run: keychain add-certificates

      - name: Setup code signing
        run: xcode-project use-profiles

      - name: Create ExportOptions.plist
        run: |
          PROFILE_PATH=$(ls ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision | head -n 1)
          echo "Found Profile Path: $PROFILE_PATH"

      - name: Cancel previous submission
        if: ${{ github.event.inputs.force_replace_review == 'true' }}
        run: |
          echo "‚ö†Ô∏è Force replacing review requested..."
          echo "üîç Checking for existing submissions for Version ID: $VERSION_ID"
          
          # Try to find submission ID
          SUBMISSION_ID=$(app-store-connect app-store-version-submissions list \
            --filter-app-store-version "$VERSION_ID" \
            --json 2>/dev/null | python3 -c "import sys,json; data=json.load(sys.stdin); print(data[0]['id'] if data else '')" 2>/dev/null || echo "")

          if [ -n "$SUBMISSION_ID" ]; then
             echo "‚úÖ Found active submission ID: $SUBMISSION_ID"
             echo "üö´ Cancelling submission..."
             app-store-connect app-store-version-submissions delete --id "$SUBMISSION_ID"
             echo "‚úÖ Cancelled."
          else
             echo "‚ÑπÔ∏è No submission ID found via list. Attempting direct delete by version ID as fallback..."
             app-store-connect app-store-version-submissions delete --app-store-version-id "$VERSION_ID" || echo "Fallback delete failed or not supported."
          fi
          
          # Extract UUID from the profile using security and PlistBuddy
          # security cms -D -i output the signed data (plist) which PlistBuddy can read
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i "$PROFILE_PATH"))
          echo "Found Profile UUID: $PROFILE_UUID"

          if [ -z "$PROFILE_UUID" ]; then
            echo "Error: Could not extract UUID from profile"
            exit 1
          fi
          
          # Create plist using printf to avoid heredoc indentation issues
          cat <<EOF > $HOME/export_options.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$BUNDLE_ID</key>
              <string>$PROFILE_UUID</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Get version info
        id: version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | sed 's/version: \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          VERSION_CODE=$(echo "$VERSION_LINE" | sed 's/version: [0-9]*\.[0-9]*\.[0-9]*+\([0-9]*\)/\1/')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION_NAME ($VERSION_CODE)"

      - name: Get latest build number
        id: build_info
        run: |
          # Use GitHub run number with offset to ensure uniqueness > 373
          # Run number increases automatically on every run
          OFFSET=400
          NEW_BUILD=$(( $GITHUB_RUN_NUMBER + $OFFSET ))
          echo "BUILD_NUMBER=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "üì± Auto-generated Build number: $NEW_BUILD"

      - name: Update Info.plist
        run: |
          # Ensure Info.plist has the correct version
          plutil -replace CFBundleShortVersionString -string "${{ steps.version.outputs.VERSION_NAME }}" ios/Runner/Info.plist
          plutil -replace CFBundleVersion -string "${{ steps.build_info.outputs.BUILD_NUMBER }}" ios/Runner/Info.plist

      - name: Build iOS App
        run: |
          flutter build ipa --release \
            --build-name=${{ steps.version.outputs.VERSION_NAME }} \
            --build-number=${{ steps.build_info.outputs.BUILD_NUMBER }} \
            --export-options-plist=$HOME/export_options.plist

      - name: Upload to App Store Connect
        run: |
          app-store-connect publish --path build/ios/ipa/*.ipa
          echo "‚úÖ Build uploaded to App Store Connect!"

      - name: Wait for build processing
        run: |
          echo "‚è≥ Waiting 5 minutes for Apple to process build..."
          sleep 300
          echo "‚úÖ Build should be processed now"

      - name: Find and link build to version
        id: link_build
        run: |
          BUILD_NUM="${{ steps.build_info.outputs.BUILD_NUMBER }}"
          echo "üîç Looking for build $BUILD_NUM..."

          # Try to find the build
          BUILD_ID=$(app-store-connect builds list \
            --app-id "$APP_ID" \
            --build-version-number "$BUILD_NUM" \
            --json 2>/dev/null | python3 -c "import sys,json; data=json.load(sys.stdin); print(data[0]['id'] if data else '')" 2>/dev/null || echo "")

          if [ -z "$BUILD_ID" ]; then
             echo "‚è≥ Build not found immediately. Waiting more..."
             sleep 120
             BUILD_ID=$(app-store-connect builds list \
              --app-id "$APP_ID" \
              --build-version-number "$BUILD_NUM" \
              --json 2>/dev/null | python3 -c "import sys,json; data=json.load(sys.stdin); print(data[0]['id'] if data else '')" 2>/dev/null || echo "")
          fi

          if [ -n "$BUILD_ID" ]; then
            echo "‚úÖ Found build ID: $BUILD_ID"
            echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
            
            # Link build to version
            echo "üîó Linking build to version (id: $VERSION_ID)..."
            app-store-connect app-store-versions modify \
              --id "$VERSION_ID" \
              --build-id "$BUILD_ID" || echo "‚ö†Ô∏è Warning: Linking failed (maybe version string mismatch or already linked)"
          else
            echo "‚ùå Could not find build $BUILD_NUM in App Store Connect yet."
            echo "‚ö†Ô∏è Proceeding without linking/submitting."
            echo "BUILD_ID=" >> $GITHUB_OUTPUT
          fi

      - name: Submit for review (optional)
        if: ${{ github.event.inputs.submit_for_review == 'true' }}
        run: |
          if [ -z "${{ steps.link_build.outputs.BUILD_ID }}" ]; then
            echo "‚ùå No build ID found to submit; skipping submission."
            exit 0
          fi
          echo "üöÄ Submitting for App Store review..."
          app-store-connect app-store-version-submissions create \
            --app-store-version-id "$VERSION_ID" || {
            echo "‚ö†Ô∏è Could not auto-submit. Please submit manually in App Store Connect."
            exit 0
          }
          echo "üéâ Successfully submitted for App Store review!"

      - name: Summary
        if: always()
        run: |
          echo "## üéâ iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "ver: ${{ steps.version.outputs.VERSION_NAME }} (${{ steps.build_info.outputs.BUILD_NUMBER }})" >> $GITHUB_STEP_SUMMARY
